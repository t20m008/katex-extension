import{allCollapse,allExpand}from"./katex-collapsible.js";import{getDefaultSetting,mutateDefaultSetting}from"./katex-localStorage.js";let katexClass=[],katexHTMLClass=[],katexMathMLClass=[],contextMenuDisplay=!1;const defaultSettingSwitch=null;let modalDisplay=!1,focusIndex=null;async function loadKaTeX(){katexClass=await document.getElementsByClassName("katex"),katexClass=Array.from(katexClass),katexHTMLClass=await document.getElementsByClassName("katex-html"),katexHTMLClass=Array.from(katexHTMLClass),katexMathMLClass=await document.getElementsByClassName("katex-mathml"),katexMathMLClass=Array.from(katexMathMLClass)}function createContextMenu(e){const t=document.createElement("div");t.oncontextmenu=function(){return!1},t.id="katex-context-menu",t.classList.add("context-menu","close");const n=document.createElement("ul"),a=(document.createElement("ul"),document.createElement("li")),l=document.createElement("li"),d=document.createElement("li"),c=document.createElement("li"),o=document.createElement("li"),s=document.createElement("li"),i=document.createElement("li"),r=document.createElement("li");return n.classList.add("ctx-ul"),n.classList.add(`ctx-ul-${e}`),n.id="ctx-ul",a.classList.add("ctx-show-mathml"),l.classList.add("ctx-show-tex"),d.classList.add("ctx-copy-mathml"),d.id="ctx-copy-mathml",c.classList.add("ctx-copy-tex"),c.id="ctx-copy-tex",o.classList.add("ctx-all-collapse"),s.classList.add("ctx-all-expand"),i.id="ctx-default-setting",r.id="ctx-default-setting-inline",a.innerText="MathMLを表示",l.innerText="TeXを表示",d.innerText="MathMLをコピー",c.innerText="TeXをコピー",o.innerText="全ての数式を折りたたむ",s.innerText=`全ての数式を展開する ${e}`,s.style.borderBottom="2px solid black",i.innerText="[*]デフォルトの開閉状態",r.innerText="[*]インライン数式の開閉",i.appendChild(createDefaultCollapsedStateRadio(getDefaultSetting()["default-collapse"])),r.appendChild(createDefaultInlineCollapsibleRadio()),[a,l,d,c,o,s,i,r].forEach(e=>{n.appendChild(e)}),n.style.fontSize="11pt",n.style.fontFamily="Osaka",t.appendChild(n),t}function createModal(e,t){modalDisplay=!0;const n=document.createElement("div");n.id="modal",n.classList.add("modal");const a=document.createElement("div");a.classList.add("modal-content");const l=document.createElement("div");l.classList.add("modal-header");const d=document.createElement("h1");d.innerText=e;const c=document.createElement("span");c.classList.add("modalClose"),c.innerText="×",c.addEventListener("click",()=>{n.remove()});const o=document.createElement("div");o.classList.add("modal-body"),o.innerHTML=`<label><input type="range" min="10" max="20" step="1" id="slider"></label><p>\n  ${t}</p>`,o.style.fontSize="15px",o.addEventListener("input",e=>{o.style.fontSize=`${e.target.value}px`}),l.appendChild(d),l.appendChild(c),a.appendChild(l),a.appendChild(o),n.appendChild(a),document.body.appendChild(n)}function createDefaultCollapsedStateRadio(e){const t=document.createElement("p"),n=document.createElement("label"),a=document.createElement("input"),l=document.createElement("span");n.classList.add("Radio"),n.id="labelCollapse",a.id="radioCollapse",a.setAttribute("name","radio"),a.setAttribute("type","radio"),l.classList.add("Radio-text"),l.innerText="折りたたむ",n.appendChild(a),n.appendChild(l);const d=document.createElement("label"),c=document.createElement("input"),o=document.createElement("span");return d.classList.add("Radio"),d.id="labelExpand",c.id="radioExpand",c.setAttribute("name","radio"),c.setAttribute("type","radio"),o.classList.add("Radio-text"),o.innerText="展開する",d.appendChild(c),d.appendChild(o),e?a.setAttribute("checked",""):c.setAttribute("checked",""),t.appendChild(n),t.appendChild(d),a.addEventListener("click",()=>{mutateDefaultSetting(!0)}),c.addEventListener("click",()=>{mutateDefaultSetting(!1)}),t}function createDefaultInlineCollapsibleRadio(e){const t=document.createElement("p"),n=document.createElement("label"),a=document.createElement("input"),l=document.createElement("span");n.classList.add("Radio"),n.id="labelInlineAble",a.setAttribute("name","radio2"),a.setAttribute("type","radio"),l.classList.add("Radio-text"),l.innerText="許可する",n.appendChild(a),n.appendChild(l);const d=document.createElement("label"),c=document.createElement("input"),o=document.createElement("span");return d.classList.add("Radio"),d.id="labelInlineDisable",c.setAttribute("name","radio2"),c.setAttribute("type","radio"),o.classList.add("Radio-text"),o.innerText="許可しない",d.appendChild(c),d.appendChild(o),e?a.setAttribute("checked",""):c.setAttribute("checked",""),t.appendChild(n),t.appendChild(d),a.addEventListener("click",()=>{mutateDefaultSetting(!0)}),c.addEventListener("click",()=>{mutateDefaultSetting(!1)}),t}function escape_html(e){return"string"!=typeof e?e:e.replace(/[&'`"<>]/g,function(e){return{"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"}[e]})}function showMathML(e){createModal("MathML",escape_html(katexMathMLClass[e].innerHTML))}function showTeX(e){createModal("TeX",katexMathMLClass[e].innerText)}function copyMathML(e){copyToClipboard(katexMathMLClass[e].innerHTML)}function copyTeX(e){copyToClipboard(katexMathMLClass[e].innerText)}function copyToClipboard(e){const t=document.createElement("pre");t.style.webkitUserSelect="auto",t.style.userSelect="auto",t.textContent=e,document.body.appendChild(t),document.getSelection().selectAllChildren(t);const n=document.execCommand("copy");return document.body.removeChild(t),n}function setCoordinateContextMenu(e,t,n){try{e.style.top=`${n}px`,e.style.left=`${t}px`}catch(e){console.error(e)}}function setFunctionContextMenu(e,t){document.getElementById("katex-context-menu");Array.from(e.children).forEach((e,n)=>{0===n?e.addEventListener("click",e=>{showMathML(t)}):1===n?e.addEventListener("click",e=>{showTeX(t)}):2===n?e.addEventListener("click",e=>{copyMathML(t)}):3===n?e.addEventListener("click",e=>{copyTeX(t)}):4===n?e.addEventListener("click",e=>{allCollapse()}):5===n?e.addEventListener("click",e=>{allExpand()}):6===n&&e.addEventListener("click",e=>{})})}async function katexContextMenu(){await loadKaTeX(),katexClass.forEach((e,t)=>{e.oncontextmenu=function(n){contextMenuDisplay=!0,null!==focusIndex&&katexClass[focusIndex].classList.remove("focus"),focusIndex=t,e.classList.add("focus");const a=document.getElementById("katex-context-menu");a&&a.remove();try{document.body.appendChild(createContextMenu(t));const e=document.getElementById("katex-context-menu"),a=document.getElementById("ctx-ul");setCoordinateContextMenu(e,n.pageX,n.pageY),setFunctionContextMenu(a,t)}catch(e){console.error(e)}return!1}}),katexClass.forEach((e,t)=>{e.addEventListener("touchmove",n=>{n.preventDefault(),contextMenuDisplay=!0,null!==focusIndex&&katexClass[focusIndex].classList.remove("focus"),focusIndex=t,e.classList.add("focus");const a=document.getElementById("katex-context-menu");a&&a.remove();try{document.body.appendChild(createContextMenu(t));const e=document.getElementById("katex-context-menu"),n=document.getElementById("ctx-ul");setCoordinateContextMenu(e,0,0),setFunctionContextMenu(n,t)}catch(e){console.error(e)}})}),addEventListener("click",e=>{const t=document.getElementById("modal"),n=document.getElementById("katex-context-menu");try{e.target===t&&!0===modalDisplay?(t.remove(),modalDisplay=!1):e.target!==n&&!0===contextMenuDisplay&&(n.remove(),contextMenuDisplay=!1),!1===contextMenuDisplay&&!1===modalDisplay&&katexClass[focusIndex]&&(katexClass[focusIndex].classList.remove("focus"),focusIndex=null)}catch(e){console.error(e)}})}export default(e,t)=>{t("katexContextMenu",katexContextMenu)};export{katexContextMenu};